<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Attendance Portal | Full Stack Simulation</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-color: #2c54a5;
            --secondary-color: #858796;
            --success-color: #1cc88a;
            --light-bg: #f8f9fc;
            --sidebar-width: 250px;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--light-bg);
            margin: 0;
            overflow-x: hidden;
        }

        /* --- Login Page --- */
        #login-section {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-color) 0%, #6085d6 100%);
        }

        .login-card {
            width: 100%;
            max-width: 450px;
            padding: 2.5rem;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        /* --- Dashboard Layout --- */
        #app-wrapper {
            display: none;
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: fixed;
            transition: all 0.3s;
            z-index: 100;
        }

        .sidebar-brand {
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 1rem;
            margin: 5px 10px;
            border-radius: 5px;
            text-decoration: none;
            cursor: pointer;
            transition: 0.2s;
        }

        .nav-link:hover, .nav-link.active {
            color: white;
            background-color: rgba(255,255,255,0.2);
        }

        .nav-link i { margin-right: 10px; width: 25px; text-align: center; }

        .content-wrapper {
            margin-left: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .topbar {
            height: 70px;
            background: white;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.05);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 2rem;
        }

        .main-content { padding: 2rem; }
        .view-section { display: none; animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Card Styles */
        .card { border: none; border-radius: 12px; box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1); }
        
        /* Helper for Login Credentials Display */
        .creds-box {
            background: #f1f3f9;
            border-radius: 8px;
            padding: 10px;
            font-size: 0.8rem;
            margin-bottom: 20px;
            border-left: 4px solid var(--secondary-color);
        }
    </style>
</head>
<body>

    <div id="login-section">
        <div class="login-card">
            <div class="text-center mb-4">
                <i class="fas fa-university fa-3x text-primary mb-3" style="color: var(--primary-color);"></i>
                <h3 class="fw-bold text-dark">Smart Attendance</h3>
                <p class="text-muted">Secure Login Portal</p>
            </div>

            <div class="creds-box">
                <strong>Default Credentials (For Testing):</strong><br>
                Admin: <i>admin@college.edu</i> / <i>admin123</i><br>
                Faculty: <i>faculty@college.edu</i> / <i>faculty123</i><br>
                Student: <i>student@college.edu</i> / <i>student123</i>
            </div>

            <div id="login-alert" class="alert alert-danger d-none">Invalid Email or Password!</div>

            <form onsubmit="handleLogin(event)">
                <div class="mb-3">
                    <label class="form-label">Email Address</label>
                    <input type="email" id="loginEmail" class="form-control form-control-lg" placeholder="name@college.edu" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" id="loginPass" class="form-control form-control-lg" placeholder="********" required>
                </div>
                <button type="submit" class="btn btn-primary btn-lg w-100 mb-3" style="background-color: var(--primary-color);">Login Securely</button>
            </form>
        </div>
    </div>

    <div id="app-wrapper">
        
        <nav class="sidebar">
            <div class="sidebar-brand">
                <i class="fas fa-graduation-cap me-2"></i> SAP PORTAL
            </div>
            <ul class="list-unstyled mt-3" id="sidebar-menu">
                </ul>
        </nav>

        <div class="content-wrapper">
            <div class="topbar">
                <div class="d-flex align-items-center gap-3">
                    <div class="text-end">
                        <div class="fw-bold text-dark" id="user-name-display">User</div>
                        <div class="small text-muted" id="user-role-display">Role</div>
                    </div>
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; font-weight:bold;" id="user-avatar">U</div>
                </div>
            </div>

            <div class="main-content">
                
                <div id="view-admin" class="view-section">
                    <h2 class="h3 mb-4 text-gray-800">Admin Dashboard</h2>
                    <div class="row">
                        <div class="col-md-4 mb-4">
                            <div class="card border-start border-primary border-4 py-2">
                                <div class="card-body">
                                    <div class="text-uppercase text-primary fw-bold text-xs mb-1">Total Users</div>
                                    <div class="h5 mb-0 fw-bold text-gray-800">2,500</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-4">
                            <div class="card border-start border-success border-4 py-2">
                                <div class="card-body">
                                    <div class="text-uppercase text-success fw-bold text-xs mb-1">Active Classes</div>
                                    <div class="h5 mb-0 fw-bold text-gray-800">45</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                             <div class="card shadow mb-4">
                                <div class="card-header py-3 bg-white">
                                    <h6 class="m-0 font-weight-bold text-primary">System Logs</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-bordered">
                                        <thead><tr><th>User</th><th>Action</th><th>Time</th></tr></thead>
                                        <tbody>
                                            <tr><td>Faculty</td><td>Marked Attendance</td><td>10:05 AM</td></tr>
                                            <tr><td>Student</td><td>Viewed Report</td><td>09:45 AM</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-faculty" class="view-section">
                    <h2 class="h3 mb-4">Class Attendance</h2>
                    <div class="card shadow mb-4">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label>Course</label>
                                    <select class="form-select"><option>Software Engineering (SE-101)</option></select>
                                </div>
                                <div class="col-md-6">
                                    <label>Date</label>
                                    <input type="date" class="form-control" id="todayDate">
                                </div>
                            </div>
                            <div class="table-responsive mt-4">
                                <table class="table table-hover align-middle">
                                    <thead class="table-light">
                                        <tr><th>ID</th><th>Name</th><th>Status</th><th>Mark</th></tr>
                                    </thead>
                                    <tbody id="attendance-list">
                                        </tbody>
                                </table>
                            </div>
                            <button class="btn btn-success float-end mt-3" onclick="saveAttendance()"><i class="fas fa-save me-2"></i>Save Records</button>
                        </div>
                    </div>
                </div>

                <div id="view-student" class="view-section">
                    <h2 class="h3 mb-4">My Attendance</h2>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card shadow mb-4">
                                <div class="card-body text-center">
                                    <canvas id="studentChart"></canvas>
                                    <h4 class="mt-3">85% Present</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card shadow">
                                <div class="card-header bg-white"><h6 class="m-0 font-weight-bold text-primary">Details</h6></div>
                                <div class="card-body">
                                    <table class="table table-bordered">
                                        <thead><tr><th>Subject</th><th>Present</th><th>Absent</th><th>Status</th></tr></thead>
                                        <tbody>
                                            <tr><td>Software Eng.</td><td>20</td><td>2</td><td><span class="badge bg-success">Good</span></td></tr>
                                            <tr><td>Web Dev</td><td>15</td><td>5</td><td><span class="badge bg-warning text-dark">Average</span></td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-settings" class="view-section">
                    <h2 class="h3 mb-4">Account Settings</h2>
                    <div class="card shadow mw-50" style="max-width: 600px;">
                        <div class="card-header bg-white border-bottom-0 pt-4">
                            <h5 class="text-primary fw-bold">Change Password</h5>
                        </div>
                        <div class="card-body">
                            <div id="settings-alert" class="alert d-none"></div>
                            <form onsubmit="handleChangePassword(event)">
                                <div class="mb-3">
                                    <label class="form-label">Current Password</label>
                                    <input type="password" id="oldPass" class="form-control" required>
                                </div>
                                <hr>
                                <div class="mb-3">
                                    <label class="form-label">New Password</label>
                                    <input type="password" id="newPass" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Confirm New Password</label>
                                    <input type="password" id="confirmPass" class="form-control" required>
                                </div>
                                <div class="d-flex justify-content-end">
                                    <button type="submit" class="btn btn-primary">Update Password</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // --- 1. LOCAL STORAGE DATABASE INITIALIZATION ---
        
        // Define Default Users (Only used if Storage is empty)
        const DEFAULT_USERS = [
            { id: 1, name: 'System Admin', email: 'admin@college.edu', password: 'admin123', role: 'admin' },
            { id: 2, name: 'Dr. John Doe', email: 'faculty@college.edu', password: 'faculty123', role: 'faculty' },
            { id: 3, name: 'Alice Student', email: 'student@college.edu', password: 'student123', role: 'student' }
        ];

        // Load Users from Storage or initialize them
        function getDBUsers() {
            const storedUsers = localStorage.getItem('sap_users');
            if (!storedUsers) {
                localStorage.setItem('sap_users', JSON.stringify(DEFAULT_USERS));
                return DEFAULT_USERS;
            }
            return JSON.parse(storedUsers);
        }

        let currentUser = null;

        // --- 2. LOGIN LOGIC ---
        function handleLogin(e) {
            e.preventDefault();
            const emailIn = document.getElementById('loginEmail').value;
            const passIn = document.getElementById('loginPass').value;
            const alertBox = document.getElementById('login-alert');

            const users = getDBUsers();
            
            // Find user matching email AND password
            const user = users.find(u => u.email === emailIn && u.password === passIn);

            if (user) {
                // SUCCESS
                currentUser = user;
                alertBox.classList.add('d-none');
                
                // Switch UI
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('app-wrapper').style.display = 'flex';
                
                // Populate UI
                setupDashboard();
            } else {
                // FAIL
                alertBox.innerText = "Invalid Credentials! Check the default logins above.";
                alertBox.classList.remove('d-none');
            }
        }

        function logout() {
            currentUser = null;
            location.reload(); // Hard reload to clear UI state
        }

        // --- 3. DASHBOARD SETUP ---
        function setupDashboard() {
            // Update Topbar
            document.getElementById('user-name-display').innerText = currentUser.name;
            document.getElementById('user-role-display').innerText = currentUser.role.toUpperCase();
            document.getElementById('user-avatar').innerText = currentUser.role.charAt(0).toUpperCase();

            // Build Menu
            const menu = document.getElementById('sidebar-menu');
            menu.innerHTML = '';

            // Common Menu Items
            let items = [];
            if(currentUser.role === 'admin') items = [
                {id: 'admin', icon: 'fa-tachometer-alt', text:'Dashboard'},
                {id: 'settings', icon: 'fa-cog', text:'Settings'}
            ];
            else if(currentUser.role === 'faculty') items = [
                {id: 'faculty', icon: 'fa-users', text:'Attendance'},
                {id: 'settings', icon: 'fa-cog', text:'Settings'}
            ];
            else items = [
                {id: 'student', icon: 'fa-user-graduate', text:'My Attendance'},
                {id: 'settings', icon: 'fa-cog', text:'Settings'}
            ];

            items.forEach(i => {
                menu.innerHTML += `<li class="nav-item"><a class="nav-link" onclick="navigate('${i.id}', this)"><i class="fas ${i.icon}"></i> ${i.text}</a></li>`;
            });

            menu.innerHTML += `<li class="nav-item mt-4"><a class="nav-link text-danger" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>`;

            // Auto-navigate to first item
            navigate(items[0].id);

            // Init specific views
            if(currentUser.role === 'faculty') initFacultyTable();
            if(currentUser.role === 'student') initStudentChart();
        }

        function navigate(viewId, el) {
            // Hide all views
            document.querySelectorAll('.view-section').forEach(d => d.style.display = 'none');
            document.getElementById('view-' + viewId).style.display = 'block';
            
            // Active class management
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            if(el) el.classList.add('active');
        }

        // --- 4. PASSWORD CHANGE LOGIC ---
        function handleChangePassword(e) {
            e.preventDefault();
            const oldPass = document.getElementById('oldPass').value;
            const newPass = document.getElementById('newPass').value;
            const confirmPass = document.getElementById('confirmPass').value;
            const alertBox = document.getElementById('settings-alert');

            // 1. Check if old password is correct
            if(oldPass !== currentUser.password) {
                showAlert(alertBox, 'danger', 'Current password is incorrect.');
                return;
            }

            // 2. Check match
            if(newPass !== confirmPass) {
                showAlert(alertBox, 'danger', 'New passwords do not match.');
                return;
            }

            // 3. Update Database
            const users = getDBUsers();
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            
            if(userIndex !== -1) {
                users[userIndex].password = newPass; // Update RAM
                currentUser.password = newPass;      // Update Session
                localStorage.setItem('sap_users', JSON.stringify(users)); // Update Disk
                
                showAlert(alertBox, 'success', 'Password updated successfully! Use new password next login.');
                document.querySelector('form').reset();
            }
        }

        function showAlert(el, type, msg) {
            el.className = `alert alert-${type}`;
            el.innerText = msg;
            el.classList.remove('d-none');
        }

        // --- 5. FACULTY LOGIC (Storing Attendance) ---
        const MOCK_STUDENTS = [
            {id: 'S01', name: 'John Smith'}, {id: 'S02', name: 'Sarah Connor'}, {id: 'S03', name: 'Kyle Reese'}
        ];

        function initFacultyTable() {
            document.getElementById('todayDate').valueAsDate = new Date();
            const tbody = document.getElementById('attendance-list');
            tbody.innerHTML = '';
            
            MOCK_STUDENTS.forEach(s => {
                tbody.innerHTML += `
                    <tr>
                        <td>${s.id}</td>
                        <td>${s.name}</td>
                        <td><span class="badge bg-secondary">Pending</span></td>
                        <td>
                            <input type="radio" class="btn-check" name="status_${s.id}" id="p_${s.id}" autocomplete="off" checked>
                            <label class="btn btn-outline-success btn-sm" for="p_${s.id}">P</label>
                            <input type="radio" class="btn-check" name="status_${s.id}" id="a_${s.id}" autocomplete="off">
                            <label class="btn btn-outline-danger btn-sm" for="a_${s.id}">A</label>
                        </td>
                    </tr>
                `;
            });
        }

        function saveAttendance() {
            // Mock saving to LocalStorage
            alert("Attendance data saved to database successfully!");
        }

        // --- 6. STUDENT LOGIC ---
        function initStudentChart() {
            const ctx = document.getElementById('studentChart');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Present', 'Absent'],
                    datasets: [{ data: [85, 15], backgroundColor: ['#2c54a5', '#e2e6ea'] }]
                }
            });
        }

    </script>
</body>
</html>
